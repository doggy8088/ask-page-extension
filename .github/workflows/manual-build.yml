name: æ‰‹å‹•å¥—ä»¶å»ºæ§‹

on:
  workflow_dispatch:
    inputs:
      version:
        description: 'ç‰ˆæœ¬è™Ÿ (ä¾‹å¦‚: v1.0.0)'
        required: true
        type: string
      create_release:
        description: 'æ˜¯å¦å»ºç«‹ GitHub Release'
        required: false
        type: boolean
        default: false

jobs:
  build:
    runs-on: ubuntu-latest

    steps:
    - name: æª¢å‡ºç¨‹å¼ç¢¼
      uses: actions/checkout@v4

    - name: è¨­å®šç‰ˆæœ¬è™Ÿ
      id: version
      run: |
        VERSION="${{ github.event.inputs.version }}"
        echo "version=$VERSION" >> $GITHUB_OUTPUT
        echo "version_number=${VERSION#v}" >> $GITHUB_OUTPUT

    - name: æ›´æ–° manifest.json ç‰ˆæœ¬
      run: |
        VERSION_NUMBER="${{ steps.version.outputs.version_number }}"
        jq --arg version "$VERSION_NUMBER" '.version = $version' manifest.json > manifest_tmp.json
        mv manifest_tmp.json manifest.json
        echo "å·²æ›´æ–°ç‰ˆæœ¬è™Ÿåˆ°: $VERSION_NUMBER"

    - name: æª¢æŸ¥æª”æ¡ˆå®Œæ•´æ€§
      run: |
        echo "æª¢æŸ¥æª”æ¡ˆå®Œæ•´æ€§..."

        # æª¢æŸ¥åŸºæœ¬æª”æ¡ˆ
        FILES=("manifest.json" "background.js" "content.js" "popup.html" "popup.js" "style.css")
        for file in "${FILES[@]}"; do
          if [ ! -f "$file" ]; then
            echo "âŒ ç¼ºå°‘æª”æ¡ˆ: $file"
            exit 1
          fi
        done

        # æª¢æŸ¥åœ–ç¤ºæª”æ¡ˆ
        ICONS=("icons/icon16.png" "icons/icon48.png" "icons/icon128.png")
        for icon in "${ICONS[@]}"; do
          if [ ! -f "$icon" ]; then
            echo "âŒ ç¼ºå°‘åœ–ç¤ºæª”æ¡ˆ: $icon"
            exit 1
          fi
        done

        # æª¢æŸ¥å‡½å¼åº«æª”æ¡ˆ
        LIBS=("lib/marked.min.js" "lib/purify.min.js")
        for lib in "${LIBS[@]}"; do
          if [ ! -f "$lib" ]; then
            echo "âŒ ç¼ºå°‘å‡½å¼åº«æª”æ¡ˆ: $lib"
            exit 1
          fi
        done

        echo "âœ… æ‰€æœ‰æª”æ¡ˆæª¢æŸ¥é€šéŽ"

    - name: å»ºç«‹å¥—ä»¶
      run: |
        VERSION="${{ steps.version.outputs.version }}"
        PACKAGE_NAME="AskPageExtension_${VERSION}.zip"

        # å»ºç«‹ ZIP å¥—ä»¶
        zip -r "$PACKAGE_NAME" \
          manifest.json \
          background.js \
          content.js \
          popup.html \
          popup.js \
          settings.html \
          settings.js \
          style.css \
          icons/ \
          lib/ \
          -x "*.git*" "*.DS_Store*" "*node_modules*"

        # æª¢æŸ¥å¥—ä»¶å¤§å°
        SIZE=$(du -k "$PACKAGE_NAME" | cut -f1)
        echo "å¥—ä»¶å¤§å°: ${SIZE}KB"

        if [ $SIZE -gt 20480 ]; then  # 20MB
          echo "âš ï¸ è­¦å‘Š: å¥—ä»¶å¤§å°è¼ƒå¤§ (${SIZE}KB)"
        fi

        echo "PACKAGE_NAME=$PACKAGE_NAME" >> $GITHUB_ENV

        # é¡¯ç¤ºå¥—ä»¶å…§å®¹
        echo "å¥—ä»¶å…§å®¹:"
        unzip -l "$PACKAGE_NAME"

    - name: ä¸Šå‚³å¥—ä»¶åˆ° Artifacts
      uses: actions/upload-artifact@v4
      with:
        name: extension-package-${{ steps.version.outputs.version }}
        path: ${{ env.PACKAGE_NAME }}

    - name: å»ºç«‹ GitHub Release
      if: ${{ github.event.inputs.create_release == 'true' }}
      uses: softprops/action-gh-release@v2
      with:
        tag_name: ${{ steps.version.outputs.version }}
        name: é å• ${{ steps.version.outputs.version }}
        files: ${{ env.PACKAGE_NAME }}
        generate_release_notes: true
        draft: true
        prerelease: false
      env:
        GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}

    - name: å»ºæ§‹ç¸½çµ
      run: |
        echo "## å¥—ä»¶å»ºæ§‹å®Œæˆ âœ…" >> $GITHUB_STEP_SUMMARY
        echo "" >> $GITHUB_STEP_SUMMARY
        echo "### å¥—ä»¶è³‡è¨Š:" >> $GITHUB_STEP_SUMMARY
        echo "- ðŸ“¦ æª”æ¡ˆåç¨±: \`${{ env.PACKAGE_NAME }}\`" >> $GITHUB_STEP_SUMMARY
        echo "- ðŸ·ï¸ ç‰ˆæœ¬è™Ÿ: \`${{ steps.version.outputs.version_number }}\`" >> $GITHUB_STEP_SUMMARY

        SIZE=$(du -k "${{ env.PACKAGE_NAME }}" | cut -f1)
        echo "- ðŸ“ æª”æ¡ˆå¤§å°: ${SIZE}KB" >> $GITHUB_STEP_SUMMARY
        echo "" >> $GITHUB_STEP_SUMMARY

        if [ "${{ github.event.inputs.create_release }}" = "true" ]; then
          echo "### ðŸ“¢ GitHub Release" >> $GITHUB_STEP_SUMMARY
          echo "å·²å»ºç«‹è‰ç¨¿ Releaseï¼Œè«‹å‰å¾€ [Releases](../../releases) é é¢æª¢æŸ¥ä¸¦ç™¼å¸ƒ" >> $GITHUB_STEP_SUMMARY
        else
          echo "### ðŸ“¥ ä¸‹è¼‰å¥—ä»¶" >> $GITHUB_STEP_SUMMARY
          echo "å¥—ä»¶å·²ä¸Šå‚³åˆ° Artifactsï¼Œè«‹åˆ° Actions é é¢ä¸‹è¼‰" >> $GITHUB_STEP_SUMMARY
        fi
