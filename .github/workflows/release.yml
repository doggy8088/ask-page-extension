name: 自動化發布

on:
  push:
    branches:
      - main
  workflow_dispatch:

jobs:
  publish:
    runs-on: ubuntu-latest

    permissions:
      contents: write

    steps:
    - name: 取出程式碼
      uses: actions/checkout@v4

    - name: Set up Node.js
      uses: actions/setup-node@v4
      with:
        node-version: '20'

    - name: Get version
      id: get_version
      run: |
        version=$(jq -r '.version' manifest.json)
        echo "version=$version" >> $GITHUB_OUTPUT

    - name: 建立 GitHub Release
      id: create_release
      uses: softprops/action-gh-release@v1
      with:
        tag_name: v${{ steps.get_version.outputs.version }}
        name: 頁問 v${{ steps.get_version.outputs.version }}
        draft: false
        prerelease: false

    - name: Create ZIP package
      run: |
        filePath="AskPageExtension_v${{ steps.get_version.outputs.version }}.zip"
        zip -r "$filePath" manifest.json background.js content.js popup.html popup.js settings.html settings.js style.css icons lib CHANGELOG.md README.md

    - name: Upload Release Asset
      uses: softprops/action-gh-release@v1
      with:
        tag_name: v${{ steps.get_version.outputs.version }}
        files: ./AskPageExtension_v${{ steps.get_version.outputs.version }}.zip

    - name: Check Chrome Web Store Secrets
      run: |
        missing_secrets=()

        if [ -z "${{ secrets.EXTENSION_ID }}" ]; then
          missing_secrets+=("EXTENSION_ID")
        fi
        if [ -z "${{ secrets.CLIENT_ID }}" ]; then
          missing_secrets+=("CLIENT_ID")
        fi
        if [ -z "${{ secrets.CLIENT_SECRET }}" ]; then
          missing_secrets+=("CLIENT_SECRET")
        fi
        if [ -z "${{ secrets.REFRESH_TOKEN }}" ]; then
          missing_secrets+=("REFRESH_TOKEN")
        fi

        if [ ${#missing_secrets[@]} -gt 0 ]; then
          echo "❌ Chrome Web Store API 相關 secrets 未完整設定"
          echo "缺少的 secrets: $(IFS=', '; echo "${missing_secrets[*]}")"
          echo "請到 GitHub Repository Settings > Secrets and variables > Actions 設定以下 secrets:"
          for secret in "${missing_secrets[@]}"; do
            echo "  - $secret"
          done
          exit 1
        else
          echo "✅ 所有必要的 Chrome Web Store secrets 都已設定"
        fi

    - name: Publish to Chrome Web Store
      uses: mnao305/chrome-extension-upload@v4.0.1
      with:
        file-path: 'AskPageExtension_v${{ steps.get_version.outputs.version }}.zip'
        extension-id: ${{ secrets.EXTENSION_ID }}
        client-id: ${{ secrets.CLIENT_ID }}
        client-secret: ${{ secrets.CLIENT_SECRET }}
        refresh-token: ${{ secrets.REFRESH_TOKEN }}
